<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Benjamin Tan Wei Hao">
    <title>Benjamin Tan's Learnings & Writings - Implementing Parallel Comprehension with Elixir Macro Goodness</title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" />

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/styles.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/blog.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/solarized-dark.css" rel="stylesheet" type="text/css" />

    <link href='//fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
  </head>
  <body id="page-top" class="index">
    <div class="top-bar"></div>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- Brand and toggle get grouped together for better mobile display -->
        <div class="navbar-header page-scroll">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">
            <img class="img-circle avatar-image" src="/images/portrait.png" alt="Portrait" />
            <span class="avatar-name">Benjamin Tan</span>
          </a>
        </div>

        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li>
              <a href="/blog" class="color1">Archive</a>
            </li>
            <li>
              <a href="http://www.manning.com/tanweihao?a_aid=exotpbook&amp;a_bid=99f537ec" class="color2" target="_blank">My Elixir Book</a>
            </li>
            <li>
              <a href="http://confreaks.com/presenters/2702-benjamin-tan" class="color3" target="_blank">Speaking</a>
            </li>
            <li>
              <a href="https://github.com/benjamintanweihao" class="color4" target="_blank">Code</a>
            </li>
            <li>
              <a href="/" class="color5" target="_blank">About</a>
            </li>
          </ul>
        </div> <!-- /.navbar-collapse -->
      </div> <!-- /.container -->
    </nav>

    <div class="wrapper">
      <section id="top">
          <div class="text-center">
  <h1>Implementing Parallel Comprehension with Elixir Macro Goodness</h1>
  <div class="author">Benjamin Tan</div>
  <time>Jul 13, 2016</time>
  <ul class="article-tag list-inline">
      <li><a href="/blog/tags/elixir/">Elixir</a></li>
      <li><a href="/blog/tags/macros/">Macros</a></li>
      <li><a href="/blog/tags/metaprogramming/">Metaprogramming</a></li>
  </ul>
</div>
 
      </section>

      <div id="main" role="main">
        <p>I have been ploughing through Chris McCords&rsquo; <a href="https://pragprog.com/book/cmelixir/metaprogramming-elixir">Metaprogramming Elixir</a> book. In one of the chapters, he talks about how Macros are key in extending Elixir. An example he gave was that of a <em>parallel</em> comprehension. Also, if you have no idea what Macros are, you should do either or both of this things:</p>

<ol>
<li>Buy Metaprogramming Elixir.</li>
<li>Read Saša Jurić&rsquo;s outstanding series on Macros. <a href="http://theerlangelist.com/article/macros_1">Here&rsquo;s Part 1</a>.</li>
<li>Throw caution to the wind and try out the example anyway.</li>
</ol>

<p>Let&rsquo;s jump straight in! Here&rsquo;s a normal comprehension:</p>
<div class="highlight"><pre class="highlight plaintext"><code>for i &lt;- 1..10, do: i * i
</code></pre></div>
<p>And here&rsquo;s how a parallel one could look like:</p>
<div class="highlight"><pre class="highlight plaintext"><code>para(for i &lt;- 1..10, do: i * i)
</code></pre></div>
<p>In this case, <code>para</code> is a Macro that runs the body of the comprehension (<code>i * i</code>) in <em>ten</em> proceses, and returns the result.</p>

<p>I don&rsquo;t recall the book containing the actual implementation, but that&rsquo;s great! This post will cover how I implemented this from scratch. Also, I have <em>one</em> week of Macro experience at the time of this post. What could go wrong?</p>

<h2>Look Ma, No Macros!</h2>

<p>Before we go metaprogramming crazy, let&rsquo;s consider how a <em>non</em>-Macro solution would look like. Here&rsquo;s a sketch:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">me</span> <span class="o">=</span> <span class="n">self</span>

<span class="n">pids</span> <span class="o">=</span> <span class="n">for</span> <span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">})</span> <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">pids</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span> 
  <span class="k">receive</span> <span class="k">do</span>
    <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">result</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>If this reminds you of parallel map, you&rsquo;re absolutely right! The only difference here is that the comprehension allows you to have generators and filters so that you can tailor the generated values to your needs. For those who have not seen the code before, let&rsquo;s unpack the code, because I think it&rsquo;s pretty cool.</p>

<p>First, we save a reference to the pid of the current process in <code>me</code>.</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">me</span> <span class="o">=</span> <span class="n">self</span>
</code></pre></div>
<p>Why? Because the value of <code>self</code> changes, like when you are inside a <code>spawn</code> for example. We are saving the pid of the current process so that we can send messages to it. In fact, this is the next thing we do: </p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">pids</span> <span class="o">=</span> <span class="n">for</span> <span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">})</span> <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>We execute the comprehension here, but instead of merely executing <code>i * i</code>, we wrap the computation in a function and pass it to <code>spawn</code>. We are effectively running the computation (again, <code>i * i</code>) in a separate process. Of course, we are not simply running the computation in a separate process. If you look closely, we are sending a message of <code>{self, i * i}</code> to <code>me</code>. Therefore, once all the computation is done, <code>me</code> will receive <em>ten</em> messages in its mailbox. </p>

<p>It&rsquo;s important to realize that the messages can come <em>out of order</em>. Imagine that the first process takes 10 seconds to complete while the rest takes less than a second. This means that the <em>first</em> process would finish its task <em>last</em>, which also means that the message would be seen last. We definitely want to preserve the order of the results coming back. That&rsquo;s the purpose of the final piece of code:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">pids</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span> 
  <span class="k">receive</span> <span class="k">do</span>
    <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="n">result</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>We know that the <code>pids</code> contain an ordered list of pids created. When <code>map</code>ped with a <code>receive</code> block <em>and</em> matching on the <code>pid</code>, we can be sure that we are matching the <code>pid</code> with the return value. Notice that the <code>^</code> in <code>^pid</code> is <em>super</em> important here, otherwise the <code>pid</code> in <code>fn pid -&gt; ... end</code> and <code>{pid, result}</code> wouldn&rsquo;t be matched.</p>

<p>So now we have a plan of attack. We have a basic idea of how to implement parallel comprehension using processes. Time to metaprogram this thing.</p>

<h2>Macros, Macros Everywhere&hellip;</h2>

<p>Let&rsquo;s start with a new module and Macro definition:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">MacroPlayground</span> <span class="k">do</span>

  <span class="k">defmacro</span> <span class="n">para</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">self</span>

  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div>
<p>I&rsquo;ve named the input argument <code>ast</code>, short of Abstract Syntax Tree. This is a good reminder that Macros take in ASTs and spit out ASTs. What we do <em>inside</em> of the Macro is the fun stuff.</p>

<p>Here&rsquo;s the plan. Given a comprehension such as <code>for i &lt;- 1..10, do: i * i</code>, extract the <code>do</code> part (<code>i * i</code>) and turn it into this:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">})</span> <span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>Then, we will add the rest of the pieces such as the code for <code>map</code>ping <code>pids</code> against the <code>receive</code> block.</p>

<p>When working with ASTs, it&rsquo;s important to understand how the AST is being represented. For example, you can wrap an expression around a <code>quote</code> block:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="kn">quote</span> <span class="k">do</span>
  <span class="n">for</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>This evaluates to:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="p">[],</span>
 <span class="p">[{</span><span class="ss">:&lt;</span><span class="o">-</span><span class="p">,</span> <span class="p">[],</span>
   <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{:</span><span class="o">..</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}]},</span>
  <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="p">{:</span><span class="o">*</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
    <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}]]}</span>
</code></pre></div>
<p>We need to replace the <code>do</code> block with our &ldquo;spawn&rdquo; version. How do we do that? <code>Macro.prewalk/2</code> to the rescue! There&rsquo;s <code>Macro.postwalk/2</code> too. So what&rsquo;s the difference? Observe:</p>

<p>First we&rsquo;ll create the AST:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="n">ast</span> <span class="o">=</span> <span class="kn">quote</span> <span class="k">do</span>
<span class="o">...&gt;</span> <span class="n">for</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span> <span class="k">do</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
<span class="o">...&gt;</span> <span class="k">end</span>
</code></pre></div>
<p>Prewalk:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">iex</span><span class="o">&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">prewalk</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="k">fn</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="s2">"-&gt; </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">node</span><span class="si">}</span><span class="s2">"</span> <span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>This returns:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:&lt;</span><span class="o">-</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{:</span><span class="o">..</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}]},</span> <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="p">{:</span><span class="o">*</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}]]}</span>
</code></pre></div>
<p>What about Postwalk?</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">iex</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Macro</span><span class="o">.</span><span class="n">postwalk</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="k">fn</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="s2">"-&gt; </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">node</span><span class="si">}</span><span class="s2">"</span> <span class="k">end</span><span class="p">)</span>
<span class="no">Macro</span><span class="o">.</span><span class="n">postwalk</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="k">fn</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="s2">"-&gt; </span><span class="si">#{</span><span class="n">inspect</span> <span class="n">node</span><span class="si">}</span><span class="s2">"</span> <span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>This time, the result is different:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}</span>
<span class="o">-&gt;</span> <span class="mi">1</span>
<span class="o">-&gt;</span> <span class="mi">10</span>
<span class="o">-&gt;</span> <span class="p">{:</span><span class="o">..</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">]}</span>
<span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:&lt;</span><span class="o">-</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">]}</span>
<span class="o">-&gt;</span> <span class="ss">:do</span>
<span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}</span>
<span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}</span>
<span class="o">-&gt;</span> <span class="p">{:</span><span class="o">*</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">]}</span>
<span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">}</span>
<span class="o">-&gt;</span> <span class="p">[</span><span class="ss">:ok</span><span class="p">]</span>
<span class="o">-&gt;</span> <span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:ok</span><span class="p">]}</span>
</code></pre></div>
<p>What <code>Macro.prewalk/2</code>/<code>Macro.postwalk/2</code> does is it takes an AST and traverse it. At each node, it applies the given funcion. That is exactly what we need. We will traverse the AST, pick out the node that matches a comprehension, then replace the <code>do</code> block with the &ldquo;<code>spawn</code>&rdquo; version.</p>

<p>Here&rsquo;s the full implementation. Scroll down further for the step by step explanations.</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">MacroPlayground</span> <span class="k">do</span>

  <span class="k">defmacro</span> <span class="n">para</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># 0. Store the pid of the current process</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">self</span>

    <span class="c1"># 6. Save the resulting pids</span>
    <span class="n">pids</span> <span class="o">=</span> <span class="no">Macro</span><span class="o">.</span><span class="n">prewalk</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="k">fn</span>
      <span class="c1"># 1. Pattern matching can be done with function arguments!</span>
      <span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">args</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="c1"># 2. Extract the do block of the comprehension</span>
        <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="n">do_block</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">last</span>

      <span class="c1"># 3. Wrap the do block around a spawn. Send the result to the</span>
      <span class="c1">#    current process.</span>
      <span class="n">spawn_do_block</span> <span class="o">=</span> <span class="kn">quote</span> <span class="k">do</span>
        <span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">me</span><span class="p">),</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">do_block</span><span class="p">)})</span> <span class="k">end</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="c1"># 4. Swap out the `do_block` (the last element of `args`)</span>
      <span class="c1">#    with the `spawn_do_block`</span>
      <span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">replace_at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="n">spawn_do_block</span><span class="p">])}</span>

      <span class="c1"># 5. We just output the same node for any other node</span>
      <span class="n">node</span> <span class="o">-&gt;</span>
        <span class="n">node</span>
    <span class="k">end</span><span class="p">)</span>

    <span class="c1"># 7. Collect the results</span>
    <span class="kn">quote</span> <span class="k">do</span>
      <span class="kn">unquote</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="k">receive</span> <span class="k">do</span>
          <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="n">result</span>
        <span class="k">end</span>
      <span class="k">end</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The function we are passing to <code>Macro.prewalk/2</code> matches on two cases. The first case is when we encounter a node that is a comprehension, and that happens when there&rsquo;s a match for <code>{:for, meta, args}</code> (Step 1). Otherwise, we simply emit the same node, leaving it unchanged (Step 5).</p>

<p>Take a look at the AST again:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="p">[],</span>
 <span class="p">[{</span><span class="ss">:&lt;</span><span class="o">-</span><span class="p">,</span> <span class="p">[],</span>
   <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{:</span><span class="o">..</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}]},</span>
  <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="p">{:</span><span class="o">*</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
    <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}]]}</span>
</code></pre></div>
<p>Here, <code>meta</code> is <code>[]</code> while <code>args</code> is this chunk:</p>
<div class="highlight"><pre class="highlight elixir"><code> <span class="p">[{</span><span class="ss">:&lt;</span><span class="o">-</span><span class="p">,</span> <span class="p">[],</span>
   <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{:</span><span class="o">..</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}]},</span>
  <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="p">{:</span><span class="o">*</span><span class="p">,</span> <span class="p">[</span><span class="ss">context:</span> <span class="no">Elixir</span><span class="p">,</span> <span class="kn">import</span><span class="p">:</span> <span class="no">Kernel</span><span class="p">],</span>
    <span class="p">[{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">},</span> <span class="p">{</span><span class="ss">:i</span><span class="p">,</span> <span class="p">[],</span> <span class="no">Elixir</span><span class="p">}]}]]</span>
</code></pre></div>
<p>Our goal is to get to the <code>do</code> bit. Thankfully, <code>args</code> is just a <code>List</code>. And the <code>do</code> bit is the last element (Step 2):</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="n">do_block</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span> <span class="o">|&gt;</span> <span class="no">List</span><span class="o">.</span><span class="n">last</span>
</code></pre></div>
<p>Now that we have the AST of the <code>do_block</code>, we can inject this into the <code>spawn</code> (Step 3). We create a new AST with the <code>quote</code> and in it we have the <code>spawn</code> expression:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">me</span><span class="p">),</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">do_block</span><span class="p">)})</span> <span class="k">end</span><span class="p">)</span>
</code></pre></div>
<p>Remember, having an expression inside a <code>quote</code> block turns it into an AST. We need to <code>unquote(me)</code> and <code>unquote(do_block)</code> in order to use its value inside the quoted expression. Finally, we savse the resulting AST into <code>spawn_do_block</code>:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">spawn_do_block</span> <span class="o">=</span> <span class="kn">quote</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="kn">unquote</span><span class="p">(</span><span class="n">me</span><span class="p">),</span> <span class="p">{</span><span class="n">self</span><span class="p">,</span> <span class="kn">unquote</span><span class="p">(</span><span class="n">do_block</span><span class="p">)})</span> <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Now, we can perform the sleight-of-hand. We simply replace the last element of <code>args</code> with <code>[do: spawn_do_block]</code>, effectively transforming the resulting AST of the orignal comprehension (Step 4):</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="p">{</span><span class="ss">:for</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="no">List</span><span class="o">.</span><span class="n">replace_at</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="k">do</span><span class="p">:</span> <span class="n">spawn_do_block</span><span class="p">])}</span>
</code></pre></div>
<p>Recall that when the comprehension executes with <code>spawn</code>s, the result is going to be a list of pids. As with the non-Macro version, the result of the comprehension is saved in the <code>pids</code> (Step 6).</p>

<p>Finally, we need to collect the results by matching pids.</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="kn">quote</span> <span class="k">do</span>
  <span class="kn">unquote</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span>
  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
    <span class="k">receive</span> <span class="k">do</span>
      <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">result</span>
    <span class="k">end</span>
  <span class="k">end</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Again, since we need to be dealing with ASTs, we need to wrap</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="n">pids</span> <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">fn</span> <span class="n">pid</span> <span class="o">-&gt;</span>
  <span class="k">receive</span> <span class="k">do</span>
    <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">result</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>in a <code>quote</code> block. However, as with <code>me</code> and <code>do_block</code>, <code>pids</code> has to be unquoted in order for it to be used in a quoted expression.</p>

<h2>Taking it for a spin</h2>
<div class="highlight"><pre class="highlight elixir"><code><span class="k">defmodule</span> <span class="no">Foo</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">MacroPlayground</span>

  <span class="k">def</span> <span class="n">foo</span> <span class="k">do</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">para</span><span class="p">(</span><span class="n">for</span> <span class="n">a</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span>
      <span class="n">b</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span>
      <span class="n">c</span> <span class="o">&lt;-</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span>
      <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">,</span>
   <span class="k">do</span><span class="p">:</span> <span class="p">{</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">})</span>

    <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="n">x</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Foo</span><span class="o">.</span><span class="n">foo</span>
</code></pre></div>
<p>This will give:</p>
<div class="highlight"><pre class="highlight plaintext"><code>[{1, 1, 1}, {1, 1, 2}, {1, 1, 3}, {1, 2, 1}, {1, 2, 2}, {1, 3, 1}, {2, 1, 1},
 {2, 1, 2}, {2, 2, 1}, {3, 1, 1}]
</code></pre></div>
<p>For good measure, you can <code>inspect</code> the pid when the results are received:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="k">receive</span> <span class="k">do</span>
  <span class="p">{</span><span class="o">^</span><span class="n">pid</span><span class="p">,</span> <span class="n">result</span><span class="p">}</span> <span class="o">-&gt;</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span> <span class="n">pid</span>  <span class="c1"># &lt;-- add this line</span>
    <span class="n">result</span>
<span class="k">end</span>
</code></pre></div>
<p>You should be able to see this:</p>
<div class="highlight"><pre class="highlight elixir"><code><span class="c1">#PID&lt;0.2170.0&gt;</span>
<span class="c1">#PID&lt;0.2171.0&gt;</span>
<span class="c1">#PID&lt;0.2172.0&gt;</span>
<span class="c1">#PID&lt;0.2173.0&gt;</span>
<span class="c1">#PID&lt;0.2174.0&gt;</span>
<span class="c1">#PID&lt;0.2175.0&gt;</span>
<span class="c1">#PID&lt;0.2176.0&gt;</span>
<span class="c1">#PID&lt;0.2177.0&gt;</span>
<span class="c1">#PID&lt;0.2178.0&gt;</span>
<span class="c1">#PID&lt;0.2179.0&gt;</span>
<span class="p">[{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
 <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}]</span>
</code></pre></div>
<p>Great Success! Hopefully this was educational. I took a while to figure this out, so don&rsquo;t feel bad if you don&rsquo;t get it the first time round. If you spot any mistakes or have suggestions for improvements, please do so in the comments. Thanks for reading!</p>

      </div>
      
      <div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'benjamintanslearningswritings'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



      <div class="spacing"></div>
    </div>

      <footer>
    <div class="container">
      <div class="spacing"></div>
      <div class="row">
        <div class="col-md-12 text-center">
          <h2>Let's Stay In Touch!</h2>
          <p>Sign up to receive updates on my latest posts and books!</p>
          <div class="spacing"></div>
          <!-- Begin MailChimp Signup Form -->

          <div id="mc_embed_signup" class="col-md-8 col-md-push-2">
            <form action="//exotpbook.us3.list-manage.com/subscribe/post?u=e6c489d8ae654374bfa191d29&amp;id=a7b19f5882" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
            <div id="mc_embed_signup_scroll">      
              
              <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn">

              <div class="mc-field-group form-group" style="overflow: hidden; padding-right: 1em;">
                <input type="email" value="" name="EMAIL" class="required email form-control" id="mce-EMAIL" placeholder="Email Address">
              </div>
              <div id="mce-responses" class="clear">
                <div class="response" id="mce-error-response" style="display:none"></div>
                <div class="response" id="mce-success-response" style="display:none"></div>
              </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
              <div style="position: absolute; left: -5000px;"><input type="text" name="b_e6c489d8ae654374bfa191d29_a7b19f5882" tabindex="-1" value=""></div>
            </form>
          </div>

          <!--End mc_embed_signup-->
          <div class="spacing"></div>
      
          <ul class="list-inline social-btns">
            <li><a href="mailto:benjamintanweihao@gmail.com"><i class="fa fa-envelope-o color1"></i></a></li>
            <li><a href="https://twitter.com/bentanweihao" target=_blank><i class="fa fa-twitter color2"></i></a></li>
            <li><a href="#top" class="page-scroll"><i class="fa fa-angle-double-up color3"></i></a></li>
            <li><a href="https://sg.linkedin.com/in/benjamintanwh" target=_blank><i class="fa fa-linkedin color4"></i></a></li>
            <li><a href="http://github.com/benjamintanweihao" target=_blank><i class="fa fa-github color5"></i></a></li>
          </ul>
          <small>Copyright by Benjamin Tan Wei Hao &copy;</small>
        </div>
      </div>
    </div>
  </footer>


  <!-- Rainbow Bar -->
  <div class="bottom-bar"></div>

    <script src="//code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js" type="text/javascript"></script>
<script src="/javascripts/modernizr.js" type="text/javascript"></script>
<script src="/javascripts/custom.js" type="text/javascript"></script>
<script src="/javascripts/ga.js" type="text/javascript"></script>


  </body>
</html>
